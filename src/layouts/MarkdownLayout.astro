---
import BaseLayout from "./BaseLayout.astro";
import FormattedDate from "../components/FormattedDate.astro";
import diffHuman from "../js/duration.js";
import { Image } from "astro:assets";

export interface Props {
  title: string;
  company?: string;
  description?: string;
  pubDate: Date;
  startDate?: Date;
  endDate?: Date;
  updatedDate?: Date;
  author?: string;
  image?: string;
  imageHeight?: number;
  imageWidth?: number;
  tags?: string[];
}

const {
  title,
  company,
  description,
  pubDate,
  startDate,
  endDate,
  updatedDate,
  author,
  image,
  imageHeight,
  imageWidth,
  tags = [],
} = Astro.props;
const base = import.meta.env.BASE_URL.endsWith("/")
  ? import.meta.env.BASE_URL
  : import.meta.env.BASE_URL + "/";
---

<BaseLayout title={title} description={description} image={image}>
  <article>
    <h1 class="post-title">{title}</h1>
    {company && <h2>{company}</h2>}

    <div class="post-meta">
      <time>
        {
          startDate || endDate ? (
            <>
              {startDate && <FormattedDate date={startDate} />}
              {endDate && (
                <>
                  {" "}
                  – <FormattedDate date={endDate} /> •
                  {diffHuman(startDate, endDate)}
                </>
              )}
            </>
          ) : (
            <FormattedDate date={pubDate} />
          )
        }
      </time>
      {author && <span class="post-author">{author}</span>}
      {
        updatedDate && (
          <span class="post-updated">
            Updated: <FormattedDate date={updatedDate} />
          </span>
        )
      }
      {
        tags.length > 0 && (
          <span class="post-tags">
            {tags.map((tag) => (
              <a href={`${base}tags/${tag}/`}>{tag}</a>
            ))}
          </span>
        )
      }
    </div>

    {
      image && (
        <figure class="post-cover">
          <Image
            src={image.startsWith("/") ? `${base}${image.slice(1)}` : image}
            alt={title}
            width={imageWidth ?? 400}
            height={imageHeight ?? 300}
          />
        </figure>
      )
    }

    <div class="post-content">
      <slot />
    </div>
  </article>

  <script>
    // Code copy functionality
    document.addEventListener("DOMContentLoaded", () => {
      const codeBlocks = document.querySelectorAll("pre.astro-code");

      codeBlocks.forEach((block) => {
        const wrapper = document.createElement("div");
        wrapper.className = "highlight";
        block.parentNode?.insertBefore(wrapper, block);
        wrapper.appendChild(block);

        const lang = block.getAttribute("data-language") || "text";

        const titleDiv = document.createElement("div");
        titleDiv.className = "code-title";
        titleDiv.textContent = lang;

        if (navigator.clipboard) {
          const button = document.createElement("button");
          button.className = "copy-button";
          button.textContent = "Copy";

          button.addEventListener("click", async () => {
            const code = block.textContent || "";
            try {
              await navigator.clipboard.writeText(code);
              button.textContent = "Copied";
              setTimeout(() => {
                button.textContent = "Copy";
              }, 1000);
            } catch (err) {
              console.error("Failed to copy:", err);
            }
          });

          titleDiv.appendChild(button);
        }

        wrapper.insertBefore(titleDiv, block);
      });
    });
  </script>

  <!-- Twitter embed script -->
  <script
    is:inline
    async
    src="https://platform.twitter.com/widgets.js"
    charset="utf-8"></script>
</BaseLayout>
